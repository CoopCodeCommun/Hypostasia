# =============================================================================
# DEV LOCAL (sans Docker) — 2 terminaux :
#   Terminal 1 : uv run python manage.py runserver
#   Terminal 2 : uv run celery -A hypostasia worker --loglevel=info
#
# PROD — mise a jour rapide via git pull dans le conteneur :
#   docker exec -it hypostasia_web bash
#   cd /app && git pull
#   uv sync                                      # si pyproject.toml a change
#   uv run python manage.py migrate              # si migrations ajoutees
#   supervisorctl -c /app/supervisord.conf restart gunicorn celery_worker  # relancer les services
# =============================================================================

services:
  web:
    build: .
    container_name: hypostasia_web
    env_file: .env
    volumes:
      - sqlite_data:/app/db
      - static_volume:/app/staticfiles
    restart: unless-stopped
    networks:
      - frontend
    command: "bash start.sh"
#    command: "sleep infinity"

  nginx:
    image: nginx:alpine
    container_name: hypostasia_nginx
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - static_volume:/app/staticfiles
    depends_on:
      - web
    restart: unless-stopped
    labels:
      # requiered
      - "traefik.enable=true"
      - "traefik.docker.network=frontend"
      - "traefik.http.routers.hypostasia.tls.certresolver=myresolver"
      - "traefik.http.services.hypostasia.loadbalancer.server.port=80"
      - "traefik.http.routers.hypostasia.rule=Host(`$DOMAIN`)"
    networks:
      - frontend
      - hypostasia

networks:
  frontend:
    external: true
  hypostasia:
    internal: true

volumes:
  sqlite_data:
  static_volume:
