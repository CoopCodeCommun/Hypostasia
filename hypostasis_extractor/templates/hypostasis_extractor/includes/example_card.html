<!-- Carte entrainement few-shot / Few-shot training card -->
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4" id="example-{{ example.id }}">
    <!-- En-tete (toujours visible) avec toggle pour reduire le body -->
    <div class="flex items-center gap-2 mb-3">
        <button type="button" class="collapsible-toggle text-slate-400 hover:text-slate-600 text-xs shrink-0"
                data-target="example-body-{{ example.id }}">
            <span class="collapsible-chevron">&#9660;</span>
        </button>
        <input type="text" value="{{ example.name }}" id="example-name-{{ example.id }}"
               class="flex-1 text-sm font-semibold border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400"
               placeholder="Nom de l'entrainement">
        <button type="button" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 shrink-0"
                hx-patch="/api/analyseurs/{{ analyseur.id }}/update_example/"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-vals='js:{
                    "example_id": {{ example.id }},
                    "name": document.getElementById("example-name-{{ example.id }}").value,
                    "example_text": document.getElementById("example-text-{{ example.id }}").value
                }'
                hx-target="#save-feedback-example-{{ example.id }}"
                hx-swap="innerHTML">Sauver</button>
        <span id="save-feedback-example-{{ example.id }}" class="text-xs text-green-600"></span>
        <button type="button" class="text-red-400 hover:text-red-600 text-sm shrink-0"
                hx-delete="/api/analyseurs/{{ analyseur.id }}/delete_example/?example_id={{ example.id }}"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-target="#example-{{ example.id }}"
                hx-swap="delete"
                hx-confirm="Supprimer cet entrainement ?">&times;</button>
    </div>

    <!-- Body complet de l'entrainement (collapsible) -->
    <div id="example-body-{{ example.id }}">

    <!-- Texte source complet (collapsible) -->
    <div class="mb-3">
        <label class="flex items-center gap-1 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 cursor-pointer collapsible-toggle"
               data-target="example-text-body-{{ example.id }}">
            <span class="collapsible-chevron text-slate-400">{% if collapse_examples or example.example_text %}&#9654;{% else %}&#9660;{% endif %}</span>
            Texte source complet
            <span class="font-normal normal-case text-slate-400">— le texte a analyser</span>
        </label>
        <div id="example-text-body-{{ example.id }}" {% if collapse_examples or example.example_text %}class="hidden"{% endif %}>
            <textarea rows="3" id="example-text-{{ example.id }}"
                      class="w-full text-sm border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-400 resize-none overflow-hidden"
                      placeholder="Ex: L'energie nucleaire est fiable et pilotable. Mais le risque d'accident reste inacceptable."
                      oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"
                      onfocus="this.style.height='auto';this.style.height=this.scrollHeight+'px'">{{ example.example_text }}</textarea>
        </div>
    </div>

    <!-- Extractions attendues (collapsible) -->
    <div class="ml-4 border-l-2 border-blue-200 pl-3">
        <div class="flex items-center justify-between mb-2">
            <label class="flex items-center gap-1 text-xs font-semibold text-blue-600 uppercase tracking-wider cursor-pointer collapsible-toggle"
                   data-target="expected-extractions-body-{{ example.id }}">
                <span class="collapsible-chevron text-blue-400">&#9660;</span>
                Extractions attendues
                <span class="font-normal normal-case text-slate-400">— ce que le LLM doit trouver</span>
            </label>
            <button type="button" class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded hover:bg-slate-200"
                    hx-post="/api/analyseurs/{{ analyseur.id }}/add_extraction/"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-vals='{"example_id": {{ example.id }}, "extraction_class": "", "extraction_text": "", "order": 0}'
                    hx-target="#extractions-{{ example.id }}"
                    hx-swap="beforeend">
                + Extraction
            </button>
        </div>
        <div id="expected-extractions-body-{{ example.id }}">
        <!-- Bouton aide + modal / Help button + modal -->
        <button type="button" class="inline-flex items-center gap-1 text-[11px] text-slate-400 hover:text-blue-500 mb-2"
                onclick="document.getElementById('help-modal-{{ example.id }}').showModal()">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <span class="underline">Aide et exemple</span>
        </button>
        <dialog id="help-modal-{{ example.id }}" class="rounded-xl shadow-2xl p-0 backdrop:bg-black/30 max-w-lg w-full">
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-bold text-slate-700">Aide : attributs et carte de resultat</h3>
                    <button type="button" class="text-slate-400 hover:text-slate-600 text-lg"
                            onclick="document.getElementById('help-modal-{{ example.id }}').close()">&times;</button>
                </div>
                <!-- Explications -->
                <div class="text-xs text-slate-500 space-y-1.5 mb-4">
                    <p><span class="font-semibold text-slate-600">Classe :</span> type de donnee cherchee, determine le nombre d'objets trouves. Ex : argument, compose chimique, personnage</p>
                    <p><span class="font-semibold text-slate-600">Texte extrait :</span> doit correspondre <span class="font-semibold text-amber-600">EXACTEMENT</span> a un passage du texte source. Copier-coller !</p>
                    <p><span class="font-semibold text-slate-600">Attributs :</span> paires cle:valeur supplementaires. L'<span class="font-semibold text-indigo-600">ordre</span> determine leur role dans la carte de resultat :</p>
                </div>
                <!-- Correspondance attributs → zones de la carte -->
                <div class="text-xs text-slate-500 space-y-1 mb-3 bg-slate-50 rounded p-2 border border-slate-100">
                    <p><span class="inline-block w-12 text-indigo-500 font-mono text-[10px]">attr 1</span> → tags en haut (separes par virgule)</p>
                    <p><span class="inline-block w-12 text-slate-600 font-mono text-[10px]">attr 2</span> → titre de la carte</p>
                    <p><span class="inline-block w-12 text-green-500 font-mono text-[10px]">texte</span> → texte extrait (non reformule)</p>
                    <p><span class="inline-block w-12 text-amber-500 font-mono text-[10px]">attr 3</span> → tag mode/stance</p>
                    <p><span class="inline-block w-12 text-slate-400 font-mono text-[10px]">attr 4</span> → hashtags (separes par virgule)</p>
                </div>
                <!-- Carte d'exemple avec la premiere extraction si elle existe -->
                <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-1 font-semibold">Apercu carte de resultat</p>
                {% with first_ext=example.extractions.first %}
                {% if first_ext %}
                    {% include "hypostasis_extractor/includes/extraction_card_preview.html" with card_extraction=first_ext %}
                {% else %}
                    {% include "hypostasis_extractor/includes/extraction_card_preview.html" with card_attr_0="epistemologie, logique" card_attr_1="Le nucleaire est une energie pilotable" card_text="L'energie nucleaire est fiable et pilotable, contrairement aux energies intermittentes..." card_attr_2="these" card_attr_3="energie, nucleaire" %}
                {% endif %}
                {% endwith %}
                <p class="text-[10px] text-slate-400 mt-2 italic">Utilisez les fleches &#9650; &#9660; pour reordonner les attributs.</p>
            </div>
        </dialog>
        {% with extraction_count=example.extractions.count %}
        <div id="extractions-{{ example.id }}" class="space-y-2">
            {% for extraction in example.extractions.all %}
                {% include "hypostasis_extractor/includes/extraction_row.html" with extraction=extraction analyseur=analyseur extraction_count=extraction_count is_first=forloop.first %}
            {% empty %}
                <p class="text-xs text-slate-400 italic">Aucune extraction.</p>
            {% endfor %}
        </div>
        {% endwith %}

        <!-- Bouton unique : sauver toutes les extractions de cet exemple -->
        <div class="flex items-center gap-2 mt-3">
            <button type="button" class="text-xs bg-blue-500 text-white px-4 py-1.5 rounded hover:bg-blue-600"
                    data-action="save-all-extractions"
                    data-example-id="{{ example.id }}">
                Sauver toutes les extractions
            </button>
            <span id="save-feedback-example-extractions-{{ example.id }}" class="text-xs text-green-600"></span>
        </div>
        </div><!-- fin expected-extractions-body -->
    </div>

    <!-- Section Resultats d'entrainement (collapsible) -->
    {% include "hypostasis_extractor/includes/test_results_section.html" with example=example analyseur=analyseur %}

    </div><!-- fin example-body -->
</div>
