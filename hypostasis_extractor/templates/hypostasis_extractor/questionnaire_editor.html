<!-- Editeur de prompt questionnaire — zone-lecture -->
<!-- / Questionnaire prompt editor — reading zone -->
<style>
    /* Textareas auto-expansibles : pas de scrollbar, pas de resize manuel */
    #questionnaire-editor textarea {
        overflow: hidden;
        min-height: 2.5rem;
        resize: none;
    }
</style>

<div class="max-w-4xl mx-auto" id="questionnaire-editor" data-prompt-id="{{ prompt_questionnaire.id }}">

    <!-- Bouton retour vers la bibliotheque / Back button to library -->
    <a href="/" class="inline-flex items-center gap-1 text-sm text-slate-500 hover:text-blue-600 mb-4">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
        </svg>
        Bibliotheque
    </a>

    <!-- En-tete avec nom et description editables -->
    <!-- / Header with editable name and description -->
    <div class="mb-6 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <div class="flex items-center gap-2 mb-3">
            <input type="text" value="{{ prompt_questionnaire.name }}" id="qp-name-{{ prompt_questionnaire.id }}"
                   class="text-xl font-bold flex-1 border-0 border-b-2 border-transparent focus:border-blue-400 focus:outline-none bg-transparent pb-1"
                   placeholder="Nom du prompt questionnaire">
        </div>
        <div class="flex items-start gap-2 mb-3">
            <textarea rows="1" id="qp-desc-{{ prompt_questionnaire.id }}"
                      class="flex-1 text-sm text-slate-500 border-0 border-b border-transparent focus:border-blue-400 focus:outline-none bg-transparent"
                      placeholder="Description (optionnelle)">{{ prompt_questionnaire.description }}</textarea>
        </div>
        <div class="flex items-center gap-2">
            <button type="button" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 shrink-0"
                    hx-patch="/api/questionnaire-prompts/{{ prompt_questionnaire.id }}/"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-vals='js:{"name": document.getElementById("qp-name-{{ prompt_questionnaire.id }}").value, "description": document.getElementById("qp-desc-{{ prompt_questionnaire.id }}").value}'
                    hx-target="#save-feedback-header-{{ prompt_questionnaire.id }}"
                    hx-swap="innerHTML">Sauver</button>
            <span id="save-feedback-header-{{ prompt_questionnaire.id }}" class="text-xs text-green-600"></span>
        </div>
    </div>

    <!-- Toggles d'injection de contexte -->
    <!-- / Context injection toggles -->
    <div class="mb-6 bg-white rounded-lg shadow-sm border border-slate-200 p-4">
        <h3 class="text-xs font-semibold text-slate-600 uppercase tracking-wider mb-3">Options de contexte</h3>
        <div class="space-y-3">
            <!-- Toggle : Inclure les extractions / Include extractions -->
            <label class="flex items-center gap-3 cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="toggle-extractions-{{ prompt_questionnaire.id }}"
                           {% if prompt_questionnaire.inclure_extractions %}checked{% endif %}
                           class="sr-only peer"
                           hx-patch="/api/questionnaire-prompts/{{ prompt_questionnaire.id }}/"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='js:{"inclure_extractions": document.getElementById("toggle-extractions-{{ prompt_questionnaire.id }}").checked}'
                           hx-target="#save-feedback-toggles-{{ prompt_questionnaire.id }}"
                           hx-swap="innerHTML"
                           hx-trigger="change">
                    <div class="w-9 h-5 bg-slate-300 rounded-full peer-checked:bg-blue-500 transition-colors"></div>
                    <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow peer-checked:translate-x-4 transition-transform"></div>
                </div>
                <span class="text-sm text-slate-700">Inclure les extractions</span>
            </label>
            <!-- Toggle : Inclure le texte original / Include original text -->
            <label class="flex items-center gap-3 cursor-pointer">
                <div class="relative">
                    <input type="checkbox" id="toggle-texte-{{ prompt_questionnaire.id }}"
                           {% if prompt_questionnaire.inclure_texte_original %}checked{% endif %}
                           class="sr-only peer"
                           hx-patch="/api/questionnaire-prompts/{{ prompt_questionnaire.id }}/"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='js:{"inclure_texte_original": document.getElementById("toggle-texte-{{ prompt_questionnaire.id }}").checked}'
                           hx-target="#save-feedback-toggles-{{ prompt_questionnaire.id }}"
                           hx-swap="innerHTML"
                           hx-trigger="change">
                    <div class="w-9 h-5 bg-slate-300 rounded-full peer-checked:bg-blue-500 transition-colors"></div>
                    <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow peer-checked:translate-x-4 transition-transform"></div>
                </div>
                <span class="text-sm text-slate-700">Inclure le texte original</span>
            </label>
        </div>
        <span id="save-feedback-toggles-{{ prompt_questionnaire.id }}" class="text-xs text-green-600 mt-2 block"></span>
    </div>

    <!-- Morceaux de prompt / Prompt pieces -->
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-slate-600 uppercase tracking-wider">Morceaux de prompt</h3>
        <button type="button" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                hx-post="/api/questionnaire-prompts/{{ prompt_questionnaire.id }}/add_piece/"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-vals='{"name": "Nouveau morceau", "role": "instruction", "content": "", "order": 0}'
                hx-target="#qp-pieces-list"
                hx-swap="beforeend">
            + Ajouter
        </button>
    </div>
    <div id="qp-pieces-list" class="space-y-3">
        {% for piece in prompt_questionnaire.pieces.all %}
            {% include "hypostasis_extractor/includes/questionnaire_piece_row.html" with piece=piece prompt_questionnaire=prompt_questionnaire %}
        {% empty %}
            <p class="text-xs text-slate-400 italic" id="qp-pieces-empty">Aucun morceau de prompt.</p>
        {% endfor %}
    </div>
</div>

<script>
(function() {
    var editor = document.getElementById('questionnaire-editor');
    if (!editor) return;

    // === Auto-resize textareas ===
    function autoResizeOne(textarea) {
        var zoneLecture = document.getElementById('zone-lecture');
        var scrollTop = zoneLecture ? zoneLecture.scrollTop : 0;
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        if (zoneLecture) zoneLecture.scrollTop = scrollTop;
    }

    function autoResizeAll() {
        var zoneLecture = document.getElementById('zone-lecture');
        var scrollTop = zoneLecture ? zoneLecture.scrollTop : 0;
        editor.querySelectorAll('textarea').forEach(function(ta) {
            ta.style.height = 'auto';
            ta.style.height = ta.scrollHeight + 'px';
        });
        if (zoneLecture) zoneLecture.scrollTop = scrollTop;
    }

    // Event delegation : input sur textarea → auto-resize
    editor.addEventListener('input', function(evt) {
        if (evt.target.tagName === 'TEXTAREA') autoResizeOne(evt.target);
    });

    // === Collapsible toggle ===
    editor.addEventListener('click', function(evt) {
        var toggle = evt.target.closest('.collapsible-toggle');
        if (!toggle) return;
        var targetId = toggle.dataset.target;
        if (!targetId) return;
        var target = document.getElementById(targetId);
        if (!target) return;
        var estReduit = target.classList.toggle('hidden');
        if (toggle.innerHTML.trim() === '\u25BC' || toggle.innerHTML.trim() === '\u25B6') {
            toggle.innerHTML = estReduit ? '\u25B6' : '\u25BC';
        }
        if (!estReduit) {
            target.querySelectorAll('textarea').forEach(function(ta) {
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
            });
        }
    });

    // === Feedback auto-clear apres swap HTMX ===
    editor.addEventListener('htmx:afterSwap', function(evt) {
        var target = evt.detail.target;
        if (target && target.id && target.id.startsWith('save-feedback-')) {
            setTimeout(function() { target.textContent = ''; }, 2000);
        }
    });

    // === Resize apres chaque swap HTMX (ajout d'elements) ===
    editor.addEventListener('htmx:afterSettle', autoResizeAll);

    // Resize initial
    autoResizeAll();
})();
</script>
