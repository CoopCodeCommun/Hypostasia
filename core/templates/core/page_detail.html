{% extends "core/base.html" %}

{% block title %}{{ page.title|default:"Lecture" }} - Hypostasia{% endblock %}

{% block extra_css %}
<style>
    /* Readability Custom Styles for Dark Mode */
    .readability-prose {
        font-family: 'Georgia', 'Cambria', 'Times New Roman', serif;
        line-height: 1.8;
        font-size: 1.125rem;
        /* 18px */
        color: #e2e8f0;
        /* slate-200 */
    }

    .readability-prose h1,
    .readability-prose h2,
    .readability-prose h3 {
        color: #f8fafc;
        /* slate-50 */
        margin-top: 2em;
        margin-bottom: 1em;
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
    }

    .readability-prose p {
        margin-bottom: 1.5em;
    }

    .readability-prose a {
        color: #38bdf8;
        /* brand-400 */
        text-decoration: underline;
        text-underline-offset: 4px;
    }

    .readability-prose blockquote {
        border-left: 4px solid #38bdf8;
        padding-left: 1rem;
        font-style: italic;
        color: #94a3b8;
        /* slate-400 */
    }

    .readability-prose img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 2rem 0;
    }

    /* Highlight Animation */
    @keyframes highlight-pulse {
        0% {
            background-color: rgba(14, 165, 233, 0.3);
        }

        /* brand-500 */
        100% {
            background-color: transparent;
        }
    }

    .highlight-active {
        animation: highlight-pulse 2s ease-out forwards;
        border-radius: 4px;
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    /* Card Flip3D Effect (Optional, simplified to fade/slide for now for robustness) */
    .perspective-1000 {
        perspective: 1000px;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-8 relative transition-all duration-500 ease-in-out"
    x-data="{ sidebarExpanded: false, showVisualization: false, vizLoaded: false }">

    <!-- Left Column: Navigation & Content -->
    <!-- Dynamically adjust width based on sidebar expansion -->
    <div class="w-full transition-all duration-500 ease-in-out" :class="sidebarExpanded ? 'lg:w-1/2' : 'lg:w-3/5'">

        <!-- Breadcrumb / Header -->
        <div
            class="flex items-center justify-between mb-6 sticky top-20 z-10 bg-slate-900/95 backdrop-blur py-4 border-b border-slate-800">
            <a href="/api/pages/"
                class="inline-flex items-center text-sm text-slate-400 hover:text-brand-400 transition-colors">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Retour aux lectures
            </a>
            <div class="flex items-center gap-3">
                {% if latest_extraction and latest_extraction.status == 'completed' %}
                <!-- Toggle Visualisation LangExtract -->
                <button @click="showVisualization = !showVisualization"
                    hx-get="/api/pages/{{ page.id }}/visualization/"
                    hx-target="#viz-content"
                    hx-swap="innerHTML"
                    hx-trigger="click once"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
                    :class="showVisualization ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : 'bg-slate-800 text-slate-400 border border-slate-700/50 hover:text-purple-400 hover:border-purple-500/30'">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <span x-text="showVisualization ? 'Texte brut' : 'Visualisation'"></span>
                </button>
                {% endif %}
                <a href="{{ page.url }}" target="_blank"
                    class="text-xs text-slate-500 hover:text-slate-300 truncate max-w-xs flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    Ouvrir l'original
                </a>
            </div>
        </div>

        <!-- Readability Viewer (texte brut) -->
        <article id="readability-content" x-show="!showVisualization"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            class="readability-prose bg-slate-800/50 p-8 md:p-12 rounded-2xl border border-slate-700/50 shadow-sm">
            {{ page.html_readability|safe }}
        </article>

        <!-- Visualisation LangExtract (injected HTML) -->
        <div x-show="showVisualization"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            id="viz-content"
            class="readability-prose bg-slate-800/50 p-8 md:p-12 rounded-2xl border border-purple-500/30 shadow-sm"
            style="display: none;">
            <div class="text-center py-12 text-slate-500">
                <svg class="animate-spin h-6 w-6 text-purple-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm">Chargement de la visualisation...</p>
            </div>
        </div>
    </div>

    <!-- Right Column: Sidebar Analysis -->
    <!-- Dynamically adjust width -->
    <div class="w-full transition-all duration-500 ease-in-out"
         :class="sidebarExpanded ? 'lg:w-1/2' : 'lg:w-2/5'"
         x-data="{ activeTab: '{% if latest_extraction and latest_extraction.status == 'completed' %}langextract{% else %}classic{% endif %}' }">

        <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto pr-2 custom-scrollbar">

            <!-- Tab Switcher -->
            <div class="flex items-center gap-2 mb-4 border-b border-slate-700/50 pb-3">
                <button @click="activeTab = 'classic'"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all"
                    :class="activeTab === 'classic' ? 'bg-brand-500/10 text-brand-400 border border-brand-500/30' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800'">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Analyse Classique
                </button>
                <button @click="activeTab = 'langextract'"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all"
                    :class="activeTab === 'langextract' ? 'bg-purple-500/10 text-purple-400 border border-purple-500/30' : 'text-slate-400 hover:text-slate-200 hover:bg-slate-800'">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    LangExtract
                </button>
            </div>

            <!-- TAB 1: Analyse Classique -->
            <div x-show="activeTab === 'classic'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">

                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="text-brand-400">Analyse</span>

                        <!-- Re-analyze Button -->
                        <button
                            class="p-1.5 ml-2 rounded-full bg-slate-800 text-slate-400 hover:text-brand-400 hover:bg-slate-700 transition-all border border-slate-700/50 hover:border-brand-500/30"
                            title="Relancer l'analyse" hx-post="/api/pages/{{ page.id }}/analyze/" hx-target="#sidebar-loop"
                            hx-swap="outerHTML" hx-indicator="#analysis-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.282c.249.769.697 1.487 1.286 2.071 1.936 1.921 5.068 1.933 6.994.022L12.5 11l-.859-.854c-1.464 1.449-3.834 1.44-5.289-.009A3.75 3.75 0 015.17 7H9V4H4zm16 16v-5h-.282a3.992 3.992 0 01-1.286-2.071 5.002 5.002 0 00-6.994-.022L11.5 13l.859.854c1.464-1.449 3.834-1.44 5.289.009.734.73 1.134 1.705 1.127 2.748L15 17v3h5z">
                                </path>
                            </svg>
                        </button>

                        <!-- Loading Indicator -->
                        <div id="analysis-indicator" class="htmx-indicator ml-1">
                            <svg class="animate-spin h-4 w-4 text-brand-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </h3>

                    <span class="bg-brand-500/10 text-brand-400 text-xs font-medium px-2.5 py-0.5 rounded border border-brand-500/20">
                        {{ page.blocks.count }} blocs
                    </span>
                </div>

                <div class="space-y-4">
                    {% include "core/includes/sidebar_items.html" %}
                </div>
            </div>

            <!-- TAB 2: LangExtract -->
            <div x-show="activeTab === 'langextract'" x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" style="display: none;">

                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="text-purple-400">LangExtract</span>

                        <!-- Extract Button -->
                        <button
                            class="p-1.5 ml-2 rounded-full bg-slate-800 text-slate-400 hover:text-purple-400 hover:bg-slate-700 transition-all border border-slate-700/50 hover:border-purple-500/30"
                            title="Lancer extraction LangExtract"
                            hx-post="/api/pages/{{ page.id }}/extract/"
                            hx-target="#extraction-results"
                            hx-swap="outerHTML"
                            hx-indicator="#extract-indicator">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </button>

                        <!-- Loading Indicator -->
                        <div id="extract-indicator" class="htmx-indicator ml-1">
                            <svg class="animate-spin h-4 w-4 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </h3>

                    {% if latest_extraction and latest_extraction.status == 'completed' %}
                    <div class="flex items-center gap-2">
                        <span class="bg-purple-500/10 text-purple-400 text-xs font-medium px-2.5 py-0.5 rounded border border-purple-500/20">
                            {{ latest_extraction.entities_count }} entites
                        </span>
                        {% if latest_extraction.processing_time_seconds %}
                        <span class="text-[10px] text-slate-500">
                            {{ latest_extraction.processing_time_seconds|floatformat:1 }}s
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                {% include "core/includes/extraction_results.html" %}
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
    function scrollToExtraction(startChar, endChar, extractionText) {
        document.querySelectorAll('.highlight-active').forEach(el => {
            el.classList.remove('highlight-active');
        });

        const container = document.getElementById('readability-content');
        if (!container) return;

        let targetNode = null;

        // Strategy: text search using extractionText
        if (extractionText) {
            const cleanSnippet = extractionText.replace(/[^\w\sÀ-ÿ]/g, '').trim().substring(0, 60);
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                const nodeText = node.textContent.replace(/[^\w\sÀ-ÿ]/g, '');
                if (nodeText.includes(cleanSnippet)) {
                    targetNode = node.parentElement;
                    break;
                }
            }
        }

        if (targetNode) {
            targetNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetNode.classList.add('highlight-active');
        } else {
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false,
                timer: 2000, timerProgressBar: true, background: '#1e293b', color: '#fff'
            });
            Toast.fire({ icon: 'warning', title: 'Passage introuvable dans le texte' });
        }
    }

    function scrollToBlock(selector, textSnippet) {
        // Remove previous highlights
        document.querySelectorAll('.highlight-active').forEach(el => {
            el.classList.remove('highlight-active');
        });

        let targetNode = null;
        const container = document.getElementById('readability-content');

        // Strategy 1: Try CSS Selector (Prioritized as per new architecture)
        if (selector) {
            try {
                // Determine if selector is scoped to container or global document
                // Usually selector is global path, but we need to ensure it's within our readability content
                // Actually, readability content usually strips original IDs/classes, so selectors might rely on structure (nth-of-type)
                // Let's try finding it inside the container first
                targetNode = container.querySelector(selector);
            } catch (e) {
                console.warn("Invalid selector or not found:", selector);
            }
        }

        // Strategy 2: Text Search (Fallback)
        if (!targetNode && textSnippet) {
            console.log("Selector failed, attempting text search...");
            const cleanSnippet = textSnippet.replace(/[^\w\sÀ-ÿ]/g, '').trim().substring(0, 50); // Simplify for matching

            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while (node = walker.nextNode()) {
                const nodeText = node.textContent.replace(/[^\w\sÀ-ÿ]/g, '');
                if (nodeText.includes(cleanSnippet)) {
                    targetNode = node.parentElement; // Highlight the parent element of the text
                    break;
                }
            }
        }

        // Execution
        if (targetNode) {
            targetNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetNode.classList.add('highlight-active');
        } else {
            console.error("Could not find block to scroll to.");
            // Notify user via toast?
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                background: '#1e293b',
                color: '#fff'
            });
            Toast.fire({
                icon: 'warning',
                title: 'Passage introuvable dans le texte'
            });
        }
    }
</script>
{% endblock %}