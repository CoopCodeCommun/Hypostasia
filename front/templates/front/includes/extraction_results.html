{# Partial: Resultats d'extraction dans le panneau droit (light theme) #}
{# Reutilise _card_body.html pour le meme rendu que l'editeur d'analyseur #}
{# / Partial: Extraction results in right panel (light theme) #}
{# / Reuses _card_body.html for same rendering as analyzer editor #}
{% load extractor_tags %}
<div class="space-y-3" id="extraction-results">
    {% if error_message %}
    <div class="bg-red-50 border border-red-200 rounded-xl p-4">
        <p class="text-sm text-red-600 font-medium">Erreur lors de l'extraction</p>
        <p class="text-xs text-red-500 mt-1">{{ error_message|truncatechars:200 }}</p>
    </div>

    {% elif entities %}
        {% for entity in entities %}
        {# Extraire les 4 premiers attributs du JSONField par ordre de cle #}
        {# / Extract first 4 attributes from JSONField by key order #}
        {% entity_json_attrs entity as entity_attrs %}
        <div class="extraction-card bg-white rounded-lg border p-3 hover:shadow-sm transition-shadow cursor-pointer relative group {% if entity.nombre_commentaires %}border-amber-400{% else %}border-slate-200{% endif %}"
             data-extraction-id="{{ entity.pk }}"
             title="Position: {{ entity.start_char }}-{{ entity.end_char }}">

            {# Boutons editer + commenter (visibles au hover) / Edit + comment buttons (visible on hover) #}
            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="btn-commenter-extraction p-1 rounded text-slate-300 hover:text-amber-500 hover:bg-amber-50"
                        data-entity-id="{{ entity.pk }}"
                        title="Commenter cette extraction"
                        hx-get="/extractions/fil_discussion/?entity_id={{ entity.pk }}"
                        hx-target="#panneau-extractions"
                        hx-swap="innerHTML">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/>
                    </svg>
                </button>
                <button class="btn-editer-extraction p-1 rounded text-slate-300 hover:text-blue-500 hover:bg-blue-50"
                        data-entity-id="{{ entity.pk }}"
                        data-page-id="{{ entity.job.page_id }}"
                        title="Modifier cette extraction">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/>
                    </svg>
                </button>
                <button class="btn-supprimer-extraction p-1 rounded text-slate-300 hover:text-red-500 hover:bg-red-50"
                        data-entity-id="{{ entity.pk }}"
                        data-page-id="{{ entity.job.page_id }}"
                        data-has-comments="{% if entity.nombre_commentaires %}true{% else %}false{% endif %}"
                        title="Supprimer cette extraction">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            {% with attr_0=entity_attrs.0 attr_1=entity_attrs.1 text=entity.extraction_text attr_2=entity_attrs.2 attr_3=entity_attrs.3 %}
                {% include "hypostasis_extractor/includes/_card_body.html" %}
            {% endwith %}

        </div>
        {% empty %}
        <div class="text-center py-8 text-slate-400 border border-dashed border-slate-200 rounded-xl">
            <p class="text-sm">Aucune entite extraite.</p>
        </div>
        {% endfor %}

        {% if entities %}
        <button class="btn-supprimer-extractions-ia w-full mt-2 px-3 py-2 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors"
                data-page-id="{{ entities.0.job.page_id }}">
            Supprimer les extractions IA
        </button>
        {% endif %}

    {% else %}
    <div class="text-center py-8 text-slate-400 border border-dashed border-slate-200 rounded-xl">
        <p class="text-sm">Lancez une analyse pour voir les resultats ici.</p>
    </div>
    {% endif %}
</div>
