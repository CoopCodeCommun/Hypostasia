{# Partial: Fil de discussion (mode debat) pour une extraction #}
{# / Partial: Discussion thread (debate mode) for an extraction #}
{% load extractor_tags %}
<div id="fil-discussion" class="space-y-4">

    {# Bouton fermer — revient au panneau normal / Close button — returns to normal panel #}
    <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold uppercase tracking-wider text-slate-500">Discussion</h3>
        <button class="btn-fermer-discussion text-slate-400 hover:text-slate-700 text-sm"
                hx-post="/extractions/panneau/"
                hx-target="#panneau-extractions"
                hx-swap="innerHTML"
                hx-vals='{"page_id": "{{ entity.job.page_id }}"}'
                title="Fermer le fil de discussion">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    {# === 1. Carte extraction complete (meme rendu que panneau extractions) === #}
    {# / === 1. Full extraction card (same rendering as extractions panel) === #}
    {% entity_json_attrs entity as entity_attrs %}
    <div class="extraction-card bg-white rounded-lg border p-3 hover:shadow-sm transition-shadow cursor-pointer relative group {% if entity.commentaires.count %}border-amber-400{% else %}border-slate-200{% endif %}"
         data-extraction-id="{{ entity.pk }}"
         title="Position: {{ entity.start_char }}-{{ entity.end_char }}">

        {# Boutons editer + commenter (visibles au hover) / Edit + comment buttons (visible on hover) #}
        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button class="btn-editer-extraction p-1 rounded text-slate-300 hover:text-blue-500 hover:bg-blue-50"
                    data-entity-id="{{ entity.pk }}"
                    data-page-id="{{ entity.job.page_id }}"
                    title="Modifier cette extraction">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/>
                </svg>
            </button>
            <button class="btn-supprimer-extraction p-1 rounded text-slate-300 hover:text-red-500 hover:bg-red-50"
                    data-entity-id="{{ entity.pk }}"
                    data-page-id="{{ entity.job.page_id }}"
                    data-has-comments="{% if entity.commentaires.count %}true{% else %}false{% endif %}"
                    title="Supprimer cette extraction">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {% with attr_0=entity_attrs.0 attr_1=entity_attrs.1 text=entity.extraction_text attr_2=entity_attrs.2 attr_3=entity_attrs.3 %}
            {% include "hypostasis_extractor/includes/_card_body.html" %}
        {% endwith %}
    </div>

    {# === 2. Reformulation (pleine largeur) — masquee si debat clos === #}
    {# / === 2. Reformulation (full width) — hidden if debate closed === #}
    {% if not entity.restitution_page %}
    <div id="zone-reformulation-{{ entity.pk }}">
        {% if entity.reformulation_en_cours %}
            <div hx-get="/extractions/fil_discussion/?entity_id={{ entity.pk }}"
                 hx-trigger="every 3s"
                 hx-target="#panneau-extractions"
                 hx-swap="innerHTML">
                <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-emerald-500 animate-pulse shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                    </svg>
                    <span class="text-xs text-emerald-700 font-medium">Reformulation en cours...</span>
                </div>
            </div>

        {% elif entity.reformulation_erreur %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <svg class="w-4 h-4 text-red-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-xs font-medium text-red-700 mb-0.5">Erreur de reformulation</p>
                        <p class="text-[10px] text-red-600">{{ entity.reformulation_erreur|truncatewords:30 }}</p>
                    </div>
                </div>
            </div>
            {% if ia_active and analyseurs_reformuler_existent %}
            <div class="mt-1">
                <button class="text-[10px] text-red-500 hover:text-red-700 font-medium flex items-center gap-1"
                        hx-get="/extractions/choisir_reformulateur/?entity_id={{ entity.pk }}"
                        hx-target="#zone-reformulation-{{ entity.pk }}"
                        hx-swap="innerHTML">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/>
                    </svg>
                    Reessayer
                </button>
            </div>
            {% endif %}

        {% elif entity.texte_reformule %}
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                <div class="flex items-center gap-1.5 mb-1.5">
                    <svg class="w-3.5 h-3.5 text-emerald-500 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                    </svg>
                    <span class="text-[10px] font-semibold text-emerald-600 uppercase tracking-wide">{{ entity.reformule_par }}</span>
                </div>
                <p class="text-sm text-emerald-900 whitespace-pre-wrap leading-relaxed">{{ entity.texte_reformule }}</p>
            </div>
            {% if ia_active and analyseurs_reformuler_existent %}
            <div class="mt-1">
                <button class="text-[10px] text-emerald-500 hover:text-emerald-700 font-medium"
                        hx-get="/extractions/choisir_reformulateur/?entity_id={{ entity.pk }}"
                        hx-target="#zone-reformulation-{{ entity.pk }}"
                        hx-swap="innerHTML">
                    Re-reformuler
                </button>
            </div>
            {% endif %}

        {% else %}
            {% if ia_active and analyseurs_reformuler_existent %}
            <button class="w-full px-2 py-1.5 text-xs font-medium text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-dashed border-emerald-300 rounded transition-colors flex items-center justify-center gap-1.5"
                    hx-get="/extractions/choisir_reformulateur/?entity_id={{ entity.pk }}"
                    hx-target="#zone-reformulation-{{ entity.pk }}"
                    hx-swap="innerHTML">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                </svg>
                Reformuler
            </button>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}

    {# === 3. Commentaires — layout SMS (propre = droite, autres = gauche) === #}
    {# / === 3. Comments — SMS layout (own = right, others = left) === #}
    <div id="liste-commentaires" class="space-y-3">
        {% for commentaire in commentaires %}
        <div class="commentaire-bulle" data-prenom="{{ commentaire.prenom }}">
            <div class="mr-12 commentaire-container-autre">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-semibold text-slate-700">{{ commentaire.prenom }}</span>
                        <span class="text-[10px] text-slate-400">{{ commentaire.created_at|date:"d/m H:i" }}</span>
                    </div>
                    <p class="text-sm text-slate-600 whitespace-pre-wrap">{{ commentaire.commentaire }}</p>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-xs text-slate-400 text-center py-2">Aucun commentaire pour le moment.</p>
        {% endfor %}
    </div>

    {% if entity.restitution_page %}
        {# === 4. Debat clos — restitution effectuee === #}
        {# / === 4. Debate closed — restitution done === #}
        <div id="debat-clos-{{ entity.pk }}" class="border-t border-slate-200 pt-3 mt-1">
            <div class="bg-violet-50 border border-violet-200 rounded-lg p-3">
                <div class="flex items-center gap-1.5 mb-2">
                    <span class="inline-block w-2.5 h-2.5 rounded-full bg-violet-500 shrink-0"></span>
                    <span class="text-xs font-bold text-violet-700 uppercase tracking-wider">Debat restitue</span>
                    <span class="text-[10px] text-violet-400 ml-auto">{{ entity.restitution_date|date:"d/m/Y H:i" }}</span>
                </div>
                <p class="text-xs text-violet-600 mb-2">Les commentaires sont clos. Une nouvelle version a ete creee.</p>
                {% if entity.restitution_texte %}
                <p id="texte-restitution-{{ entity.pk }}" class="text-sm text-violet-900 whitespace-pre-wrap leading-relaxed bg-violet-100 rounded p-2 mb-2">{{ entity.restitution_texte }}</p>
                {% endif %}
                <a id="lien-restitution-{{ entity.pk }}"
                   href="#"
                   hx-get="/lire/{{ entity.restitution_page.pk }}/"
                   hx-target="#zone-lecture"
                   hx-swap="innerHTML"
                   hx-push-url="true"
                   class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-violet-600 hover:bg-violet-700 rounded transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/>
                    </svg>
                    Voir la version {{ entity.restitution_page.version_number }}{% if entity.restitution_page.version_label %} — {{ entity.restitution_page.version_label }}{% endif %}
                </a>
            </div>
        </div>
    {% else %}
        {# Formulaire d'ajout de commentaire / Comment form #}
        <form hx-post="/extractions/ajouter_commentaire/"
              hx-target="#panneau-extractions"
              hx-swap="innerHTML"
              class="space-y-2 border-t border-slate-200 pt-3"
              id="formulaire-commentaire">
            <input type="hidden" name="entity_id" value="{{ entity.pk }}">
            <input type="text" name="prenom" placeholder="Votre prenom"
                   class="w-full text-sm border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-amber-400"
                   required>
            <textarea name="commentaire" rows="3" placeholder="Votre commentaire…"
                      class="w-full text-sm border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-amber-400 resize-none"
                      required></textarea>
            <button type="submit"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded px-3 py-1.5 transition-colors">
                Envoyer
            </button>
        </form>

        {# === 5. Restitution du debat — ouvre un modal === #}
        {# / === 5. Debate restitution — opens a modal === #}
        <div class="border-t border-slate-200 pt-3 mt-3">
            <button id="btn-restituer-{{ entity.pk }}"
                    class="w-full px-3 py-2 text-xs font-bold text-violet-700 bg-violet-50 hover:bg-violet-100 border border-dashed border-violet-300 rounded transition-colors uppercase tracking-wider"
                    onclick="document.getElementById('modal-restitution-{{ entity.pk }}').classList.remove('hidden')">
                Restituer le debat
            </button>
        </div>

        {# Modal de restitution / Restitution modal #}
        <div id="modal-restitution-{{ entity.pk }}"
             class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40"
             onclick="if(event.target===this) this.classList.add('hidden')">
            <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 p-5" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold text-violet-700 uppercase tracking-wider">Restituer le debat</h3>
                    <button onclick="document.getElementById('modal-restitution-{{ entity.pk }}').classList.add('hidden')"
                            class="text-slate-400 hover:text-slate-600 text-lg leading-none">&times;</button>
                </div>
                <form id="formulaire-restitution"
                      hx-post="/extractions/creer_restitution/"
                      hx-target="#zone-lecture"
                      hx-swap="innerHTML"
                      class="space-y-3">
                    <input type="hidden" name="entity_id" value="{{ entity.pk }}">
                    <div>
                        <label for="input-version-label" class="block text-xs font-medium text-slate-600 mb-1">Label de version (optionnel)</label>
                        <input id="input-version-label" type="text" name="version_label"
                               placeholder="ex: Restitution du debat, Synthese..."
                               class="w-full px-3 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-violet-500 focus:border-violet-500">
                    </div>
                    {# Zone IA restitution — recoit les partials HTMX (choix analyseur, confirmation, polling) #}
                    {# / AI restitution zone — receives HTMX partials (analyzer choice, confirmation, polling) #}
                    <div id="zone-restitution-ia-{{ entity.pk }}"></div>

                    <div>
                        <label for="textarea-texte-restitution" class="block text-xs font-medium text-slate-600 mb-1">Resume / Texte de restitution</label>
                        <textarea id="textarea-texte-restitution" name="texte_restitution" rows="6"
                                  class="w-full px-3 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-violet-500 focus:border-violet-500 resize-none"
                                  placeholder="Redigez votre restitution du debat..."
                                  required>{% if entity.texte_restitution_ia %}{{ entity.texte_restitution_ia }}{% endif %}</textarea>
                    </div>
                    <div class="flex items-center gap-2 pt-1">
                        <button id="btn-submit-restitution" type="submit"
                                class="px-4 py-1.5 text-sm font-medium text-white bg-violet-600 rounded-md hover:bg-violet-700 transition-colors">
                            Creer la restitution
                        </button>
                        <button id="btn-annuler-restitution" type="button"
                                onclick="document.getElementById('modal-restitution-{{ entity.pk }}').classList.add('hidden')"
                                class="px-4 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors">
                            Annuler
                        </button>
                        {% if ia_active and analyseurs_restituer_existent %}
                        <button id="btn-ia-restitution-{{ entity.pk }}" type="button"
                                class="ml-auto px-4 py-1.5 text-sm font-medium text-violet-600 bg-white border border-violet-300 rounded-md hover:bg-violet-50 transition-colors flex items-center gap-1.5"
                                hx-get="/extractions/choisir_restituteur/?entity_id={{ entity.pk }}"
                                hx-target="#zone-restitution-ia-{{ entity.pk }}"
                                hx-swap="innerHTML">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                            </svg>
                            IA
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    {% endif %}
</div>

<script>
(function() {
    // Layout SMS : compare le prenom de chaque commentaire avec celui stocke en localStorage
    // / SMS layout: compare each comment's name with the one stored in localStorage
    var prenomUtilisateur = localStorage.getItem('hypo_prenom');
    if (prenomUtilisateur) {
        document.querySelectorAll('#liste-commentaires .commentaire-bulle').forEach(function(bulle) {
            if (bulle.dataset.prenom === prenomUtilisateur) {
                var conteneur = bulle.querySelector('.commentaire-container-autre');
                if (conteneur) {
                    conteneur.className = 'ml-12 commentaire-container-propre';
                    var carte = conteneur.querySelector('div');
                    if (carte) {
                        carte.className = 'bg-white border border-slate-200 rounded-lg p-3';
                    }
                }
            }
        });
    }

    // Pre-remplir le champ prenom depuis localStorage
    // / Pre-fill name field from localStorage
    var champPrenom = document.querySelector('#formulaire-commentaire input[name="prenom"]');
    if (champPrenom && prenomUtilisateur) {
        champPrenom.value = prenomUtilisateur;
    }

    // Au submit, stocker le prenom en localStorage
    // / On submit, store name in localStorage
    var formulaire = document.getElementById('formulaire-commentaire');
    if (formulaire) {
        formulaire.addEventListener('submit', function() {
            var valeurPrenom = formulaire.querySelector('input[name="prenom"]').value.trim();
            if (valeurPrenom) {
                localStorage.setItem('hypo_prenom', valeurPrenom);
            }
        });
    }
})();
</script>
