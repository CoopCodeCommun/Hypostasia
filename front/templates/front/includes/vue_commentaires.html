{# Partial: Vue globale des commentaires — lecture seule, clic extraction = ouvre fil de discussion #}
{# / Partial: Global comments view — read-only, click extraction = opens discussion thread #}
{% load extractor_tags %}

{% if entites_avec_commentaires %}
<div id="vue-commentaires-global" class="space-y-6">
    {% for entite in entites_avec_commentaires %}
    {% entity_json_attrs entite as entite_attrs %}
    <div class="space-y-2">

        {# === 1. Carte extraction complete (cliquable → ouvre fil de discussion) === #}
        {# / === 1. Full extraction card (clickable → opens discussion thread) === #}
        <div class="extraction-card bg-white rounded-lg border p-3 hover:shadow-sm transition-shadow cursor-pointer relative group border-amber-400"
             data-extraction-id="{{ entite.pk }}"
             hx-get="/extractions/fil_discussion/?entity_id={{ entite.pk }}"
             hx-target="#panneau-extractions"
             hx-swap="innerHTML"
             title="Position: {{ entite.start_char }}-{{ entite.end_char }}">

            {% with attr_0=entite_attrs.0 attr_1=entite_attrs.1 text=entite.extraction_text attr_2=entite_attrs.2 attr_3=entite_attrs.3 %}
                {% include "hypostasis_extractor/includes/_card_body.html" %}
            {% endwith %}
        </div>

        {# === 2. Reformulation en lecture seule (pleine largeur) === #}
        {# / === 2. Read-only reformulation (full width) === #}
        {% if entite.reformulation_en_cours %}
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3 flex items-center gap-2">
                <svg class="w-4 h-4 text-emerald-500 animate-pulse shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                </svg>
                <span class="text-xs text-emerald-700 font-medium">Reformulation en cours...</span>
            </div>

        {% elif entite.reformulation_erreur %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <svg class="w-4 h-4 text-red-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="text-xs font-medium text-red-700 mb-0.5">Erreur de reformulation</p>
                        <p class="text-[10px] text-red-600">{{ entite.reformulation_erreur|truncatewords:30 }}</p>
                    </div>
                </div>
            </div>

        {% elif entite.texte_reformule %}
            <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                <div class="flex items-center gap-1.5 mb-1.5">
                    <svg class="w-3.5 h-3.5 text-emerald-500 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
                    </svg>
                    <span class="text-[10px] font-semibold text-emerald-600 uppercase tracking-wide">{{ entite.reformule_par }}</span>
                </div>
                <p class="text-sm text-emerald-900 whitespace-pre-wrap leading-relaxed">{{ entite.texte_reformule }}</p>
            </div>
        {% endif %}

        {# === 3. Commentaires — layout SMS (propre = droite, autres = gauche) === #}
        {# / === 3. Comments — SMS layout (own = right, others = left) === #}
        {% for commentaire in entite.commentaires.all %}
        <div class="commentaire-bulle-global" data-prenom="{{ commentaire.prenom }}">
            <div class="mr-12 commentaire-container-autre">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-semibold text-slate-700">{{ commentaire.prenom }}</span>
                        <span class="text-[10px] text-slate-400">{{ commentaire.created_at|date:"d/m H:i" }}</span>
                    </div>
                    <p class="text-sm text-slate-600 whitespace-pre-wrap">{{ commentaire.commentaire }}</p>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
    {% endfor %}
</div>

<script>
(function() {
    // Layout SMS : positionne les commentaires propres a droite
    // / SMS layout: position own comments on the right
    var prenomUtilisateur = localStorage.getItem('hypo_prenom');
    if (prenomUtilisateur) {
        document.querySelectorAll('.commentaire-bulle-global').forEach(function(bulle) {
            if (bulle.dataset.prenom === prenomUtilisateur) {
                var conteneur = bulle.querySelector('.commentaire-container-autre');
                if (conteneur) {
                    conteneur.className = 'ml-12 commentaire-container-propre';
                    var carte = conteneur.querySelector('div');
                    if (carte) {
                        carte.className = 'bg-white border border-slate-200 rounded-lg p-3';
                    }
                }
            }
        });
    }
})();
</script>

{% else %}
<div class="flex flex-col items-center justify-center py-12 text-center">
    <svg class="w-10 h-10 text-slate-300 mb-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.068.157 2.148.279 3.238.364.466.037.893.281 1.153.671L12 21l2.652-3.978c.26-.39.687-.634 1.153-.671 1.09-.085 2.17-.207 3.238-.364 1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"></path>
    </svg>
    <p class="text-sm text-slate-400">Aucun commentaire pour le moment.</p>
    <p class="text-xs text-slate-300 mt-1">Les commentaires apparaitront ici.</p>
</div>
{% endif %}
